<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>SSL证书的配置过程 - yuluo</title><meta description="Apache 2配置SSL证书本文描述在 Apache 2.x HTTP 服务器上安装并配置 SSL 证书。"><meta property="og:type" content="article"><meta property="og:title" content="SSL证书的配置过程"><meta property="og:url" content="yuluo-ding.github.io/2016/10/27/SSL%E8%AF%81%E4%B9%A6%E7%9A%84%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B/"><meta property="og:site_name" content="yuluo"><meta property="og:description" content="Apache 2配置SSL证书本文描述在 Apache 2.x HTTP 服务器上安装并配置 SSL 证书。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="/img/og_image.png"><meta property="article:published_time" content="2016-10-27T01:44:42.000Z"><meta property="article:modified_time" content="2016-10-27T01:45:36.000Z"><meta property="article:author" content="Luo Yu"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"yuluo-ding.github.io/2016/10/27/SSL%E8%AF%81%E4%B9%A6%E7%9A%84%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B/"},"headline":"yuluo","image":["/img/og_image.png"],"datePublished":"2016-10-27T01:44:42.000Z","dateModified":"2016-10-27T01:45:36.000Z","author":{"@type":"Person","name":"Luo Yu"},"description":"Apache 2配置SSL证书本文描述在 Apache 2.x HTTP 服务器上安装并配置 SSL 证书。"}</script><link rel="canonical" href="yuluo-ding.github.io/2016/10/27/SSL%E8%AF%81%E4%B9%A6%E7%9A%84%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B/"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><!--!--><meta name="generator" content="Hexo 5.1.1"></head><body class="is-1-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/" alt="yuluo" height="28"></a></div><div class="navbar-menu"><div class="navbar-end"></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-12"><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2016-10-27T01:44:42.000Z" title="2016-10-27T01:44:42.000Z">2016-10-27</time>发表</span><span class="level-item"><time dateTime="2016-10-27T01:45:36.000Z" title="2016-10-27T01:45:36.000Z">2016-10-27</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Linux/">Linux</a></span></div></div><h1 class="title is-3 is-size-4-mobile">SSL证书的配置过程</h1><div class="content"><h3 id="Apache-2配置SSL证书"><a href="#Apache-2配置SSL证书" class="headerlink" title="Apache 2配置SSL证书"></a>Apache 2配置SSL证书</h3><p>本文描述在 Apache 2.x HTTP 服务器上安装并配置 SSL 证书。</p>
<a id="more"></a>

<h4 id="确保Apache-SSL模块的开启"><a href="#确保Apache-SSL模块的开启" class="headerlink" title="确保Apache SSL模块的开启"></a>确保Apache SSL模块的开启</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo a2enmod ssl</span><br></pre></td></tr></table></figure>

<h4 id="配置SSL证书"><a href="#配置SSL证书" class="headerlink" title="配置SSL证书"></a>配置SSL证书</h4><p>完整的SSL证书分为四个部分：</p>
<ul>
<li>CA 根证书 (root CA)</li>
<li>中级证书 (Intermediate Certificate)</li>
<li>域名证书</li>
<li>证书密钥 (仅本人持有)</li>
</ul>
<p>以 COMODO PositiveSSL 证书为例，将收到四份文件：</p>
<ul>
<li>根证书 - <code>AddTrustExternalCARoot.crt</code></li>
<li>中级证书 - <code>COMODORSAAddTrustCA.crt</code></li>
<li>中级证书 - <code>COMODORSADomainValidationSecureServerCA.crt</code></li>
<li>您的域名证书 - <code>example_com.crt</code></li>
</ul>
<p>要依照 <strong>中间证书 -&gt; 根证书</strong> 的顺序串联为证书链，才能被绝大多数浏览器信任。使用 <code>cat</code> 命令串联证书：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat COMODORSADomainValidationSecureServerCA.crt COMODORSAAddTrustCA.crt AddTrustExternalCARoot.crt &gt; ca-bundle.crt</span><br></pre></td></tr></table></figure>

<p>得到 <code>ca-bundle.crt</code> 后，和证书文件 <code>example_com.crt</code>，密钥文件 <code>example_com.key</code> 一同上传至服务器并保存在安全的位置，例如 <code>/etc/ssl/private</code> 目录下 (没有此目录请创建)。</p>
<h4 id="修改Apache站点配置"><a href="#修改Apache站点配置" class="headerlink" title="修改Apache站点配置"></a>修改Apache站点配置</h4><p>下面是一份针对 Apache 2.4 的 SSL 部分配置</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SSLEngine on</span><br><span class="line">SSLCertificateFile    <span class="regexp">/etc/</span>ssl<span class="regexp">/private/</span>example_com.crt</span><br><span class="line">SSLCertificateKeyFile <span class="regexp">/etc/</span>ssl<span class="regexp">/private/</span>example_com.key</span><br><span class="line">SSLCertificateChainFile <span class="regexp">/etc/</span>ssl<span class="regexp">/private/</span>ca-bundle.crt</span><br></pre></td></tr></table></figure>

<p>以下为 <VirtualHost> 的详细配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost *:443&gt;</span><br><span class="line">DocumentRoot /var/www/</span><br><span class="line">SSLEngine on</span><br><span class="line">SSLCertificateFile    /etc/ssl/private/example_com.crt</span><br><span class="line">SSLCertificateKeyFile /etc/ssl/private/example_com.key</span><br><span class="line">SSLCertificateChainFile /etc/ssl/private/ca-bundle.crt</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<p><strong>请注意如果你的 Apache2 版本大于 2.4.8，您可以将所有证书串联为一个文件作为 SSLCertificateFile 的值，而不必写 SSLCertificateChainFile</strong></p>
<h4 id="强制定向到HTTPS"><a href="#强制定向到HTTPS" class="headerlink" title="强制定向到HTTPS"></a>强制定向到HTTPS</h4><p>首先，我们需要确认 Apache 开启 <code>mod_rewrite</code> 模块，如果没有开启，请使用 <code>sudo a2enmod rewrite</code> 命令开启。</p>
<p>其次，你需要在站点配置文件中开启 <code>AllowOverride</code>，这样 <code>.htaccess</code> 文件才会起作用。</p>
<p>开启并重启 <code>Apache</code> 后，复制一下代码到你目录的 <code>.htaccess</code> 文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RewriteEngine On</span><br><span class="line">RewriteCond %&#123;HTTPS&#125; off</span><br><span class="line">RewriteRule (.*) https://%&#123;HTTP_HOST&#125;%&#123;REQUEST_URI&#125;</span><br></pre></td></tr></table></figure>

<h4 id="SSL安全配置"><a href="#SSL安全配置" class="headerlink" title="SSL安全配置"></a>SSL安全配置</h4><h5 id="禁用压缩"><a href="#禁用压缩" class="headerlink" title="禁用压缩"></a>禁用压缩</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">SSLCompression</span> <span class="literal">off</span></span><br></pre></td></tr></table></figure>

<h5 id="禁用-SSLv2-和-SSLv3"><a href="#禁用-SSLv2-和-SSLv3" class="headerlink" title="禁用 SSLv2 和 SSLv3"></a>禁用 SSLv2 和 SSLv3</h5><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SSLProtocol All -SSLv2 -SSLv3</span><br></pre></td></tr></table></figure>

<h5 id="抵御-Poodle-和-SSL-Downgrade-攻击"><a href="#抵御-Poodle-和-SSL-Downgrade-攻击" class="headerlink" title="抵御 Poodle 和 SSL Downgrade 攻击"></a>抵御 Poodle 和 SSL Downgrade 攻击</h5><p>您需要支持 <code>TLS-FALLBACK-SCSV</code> 以自动开启此功能。下列 OpenSSL 版本包含对 <code>TLS-FALLBACK-SCSV</code> 的支持，Lighttpd 会自动启用此特性。</p>
<ul>
<li>OpenSSL <strong>1.0.1</strong> 在 <code>1.0.1j</code> 及之后的版本中支持</li>
<li>OpenSSL <strong>1.0.0</strong> 在 <code>1.0.0o</code> 及之后的版本中支持</li>
<li>OpenSSL <strong>0.9.8</strong> 在 <code>0.9.8zc</code> 及之后的版本中支持</li>
</ul>
<h5 id="加密和交换算法"><a href="#加密和交换算法" class="headerlink" title="加密和交换算法"></a>加密和交换算法</h5><p>一份推荐的配置：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SSLCipherSuite <span class="number">EECDH</span>+AESGCM:<span class="number">EDH</span>+AESGCM:AES256+<span class="number">EECDH</span>:AES256+<span class="number">EDH</span></span><br></pre></td></tr></table></figure>

<p>如果您需要兼容老式系统和浏览器 (Windows XP, IE6)，请使用下面的：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SSLCipherSuite EECDH+<span class="string">AESGCM:</span>EDH+<span class="string">AESGCM:</span>AES256+<span class="string">EECDH:</span>ECDHE-RSA-AES128-<span class="string">SHA:</span>DHE-RSA-AES128-GCM-<span class="string">SHA256:</span>AES256+<span class="string">EDH:</span>ECDHE-RSA-AES256-GCM-<span class="string">SHA384:</span>ECDHE-RSA-AES128-GCM-<span class="string">SHA256:</span>DHE-RSA-AES256-GCM-<span class="string">SHA384:</span>ECDHE-RSA-AES256-<span class="string">SHA384:</span>ECDHE-RSA-AES128-<span class="string">SHA256:</span>ECDHE-RSA-AES256-<span class="string">SHA:</span>DHE-RSA-AES256-<span class="string">SHA256:</span>DHE-RSA-AES128-<span class="string">SHA256:</span>DHE-RSA-AES256-<span class="string">SHA:</span>DHE-RSA-AES128-<span class="string">SHA:</span>ECDHE-RSA-DES-CBC3-<span class="string">SHA:</span>EDH-RSA-DES-CBC3-<span class="string">SHA:</span>AES256-GCM-<span class="string">SHA384:</span>AES128-GCM-<span class="string">SHA256:</span>AES256-<span class="string">SHA256:</span>AES128-<span class="string">SHA256:</span>AES256-<span class="string">SHA:</span>AES128-<span class="string">SHA:</span>DES-CBC3-<span class="string">SHA:</span><span class="string">HIGH:</span>!<span class="string">aNULL:</span>!<span class="string">eNULL:</span>!<span class="string">EXPORT:</span>!<span class="string">DES:</span>!<span class="string">MD5:</span>!<span class="string">PSK:</span>!RC4</span><br></pre></td></tr></table></figure>

<h5 id="Forward-Secrecy-和-DHE-参数"><a href="#Forward-Secrecy-和-DHE-参数" class="headerlink" title="Forward Secrecy 和 DHE 参数"></a>Forward Secrecy 和 DHE 参数</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/ssl/certs</span><br><span class="line">openssl dhparam -out dhparam.pem 4096</span><br></pre></td></tr></table></figure>

<p><strong>建议您使用性能强劲的平台生成此文件</strong>，例如最新版的至强物理机。如果您只有一台小型 VPS，请使用 <code>openssl dhparam -out dhparam.pem 2048</code> 命令生成 2048bit 的参数文件。</p>
<p>添加到配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SSLOpenSSLConfCmd DHParameters "/etc/ssl/certs/dhparam.pem"</span><br></pre></td></tr></table></figure>

<h5 id="启用-HSTS"><a href="#启用-HSTS" class="headerlink" title="启用 HSTS"></a>启用 HSTS</h5><p>添加到配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Optionally load the headers module:</span></span><br><span class="line">LoadModule headers_module modules/mod_headers.so</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost 67.89.123.45:443&gt;</span><br><span class="line">    Header always set Strict-Transport-Security "max-age=63072000; includeSubdomains; preload"</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<h2 id="重启-Apache"><a href="#重启-Apache" class="headerlink" title="重启 Apache"></a>重启 Apache</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service apache2 restart</span><br></pre></td></tr></table></figure>





</div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2016/11/10/Git%E7%A7%BB%E9%99%A4-deal%E7%AD%89%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Git移除.deal等配置文件</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2016/10/24/Linux%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%88%86%E8%BE%A8%E7%8E%87%E8%AE%BE%E7%BD%AE/"><span class="level-item">Linux虚拟机分辨率设置</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><!--!--><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/" alt="yuluo" height="28"></a><p class="size-small"><span>&copy; 2020 Luo Yu</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'yuluo-ding.github.io',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><!--!--><script src="/js/main.js" defer></script><!--!--></body></html>